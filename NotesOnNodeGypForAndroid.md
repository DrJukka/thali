---
title: Notes on Node-Gyp for Android
layout: default
---

#WARNING#
These are my raw notes trying to figure out how to get Node-Gyp on Linux to build for Android. As I learn more I'll clean these up and eventually (if things work) turn them into instructions or (if things don't work) explain the problem. But for now, they are just a mess. You have been warned!

#The Notes#
The immediate goal is to build node-leveldown. 

I started simply on my Linux box and ran "npm install leveldown". That worked just fine, including building leveldb which is a C program.

Then I decided to get fancy and tried "npm install leveldown --dist-os=android". This 'worked' in the sense that stuff got built what what got built was Linux code, no Android code.

So clearly I wasn't passing on the right 'stuff' so NPM would tell node-gyp to build for Android. But how to fix this?

I couldn't find anything on how to use NPM so it would tell node-gyp to build binaries for Android so I decided to pop down a level and try to understand node-gyp. I figure if I can grok that then maybe I can understand the issues.

So first I installed node-gyp directly, sudo npm install node-gyp -g. To use node-gyp directly I needed all the leveldown files to be available (normally NPM would download those files automatically but I'm not using npm for the moment, just node-gyp). So I cloned leveldown and in the root ran: npm install. This was just to make sure that things were there. It built just fine, including dev dependencies.

So then, still in the leveldown clone, I tried "node-gyp configure" and "node-gyp build" and they ran fine. But I think that's just because I had already built them. So I decided to push my luck and try "node-gyp rebuild" which includes a cleaning step. That worked just fine as well.

Just to test things I decided to delete the node_modules and build directories and try "node-gyp rebuild" again. That failed. I got a nan on finding a module. That actually makes a lot of sense because once I deleted those directories none of the dev dependencies were there. So the important lesson is that I do need to start with 'npm install' and then run 'node-gyp clean' to get to the point where at least in theory I could build for Android.

Now in theory the way one should, I think, get node-gyp to build for Android is something along the lines of 'node-gyp rebuild --dist-os=android'. That does appear to work but it's actually just building for Linux. The --dist-os=android argument is passed to the Python build scripts but the command line for python includes "-f make" which won't trigger any of the Android logic. So it's effectively a no-op.

In truth I dug into the node-gyp code and looked at the JS for handling the call to node-gyp and it will ignore --dist-op. Or, to be more exact, it won't use it for creating the command line arguments to call python. Instead it will pack up the argument in a structure it passes to the Python code via a config file but by then it's apparently too late. I think.

I actually tried a little experiment, I issued the following:
yaron@yaron-elementary-VirtualBox:/tmp/node-leveldown$ /usr/lib/node_modules/node-gyp/gyp/gyp_main.py binding.gyp -f android -I /tmp/node-leveldown/build/config.gypi -I /usr/lib/node_modules/node-gyp/addon.gypi -I /home/yaron/.node-gyp/0.10.32/common.gypi -Dlibrary=shared_library -Dvisibility=default -Dnode_root_dir=/home/yaron/.node-gyp/0.10.32 -Dmodule_root_dir=/tmp/node-leveldown --depth=. --no-parallel --generator-output build -Goutput_dir=.

The bad news is that it blew up because of some Android specific issues but the good news is that it blew up because of Android specific issues!!!!! But I admit that now I'm just trying voodoo. The previous is the command line generated by calling node-gyp on Linux where I changed the '-f' argument to be android.

To make things more reasonable I need to understand the code better. The fund beings in the node file node-gyp but after creating the command line args and config file it calls gyp_main.py -> which imports the gyp library and calls gyp/pylib/gyp and then calls gyp.script_main() which calls __init__.py which then calls main() which calls gyp_main() which seems to be where the real fun is at. This is where we process all the command line args and start launching things. What I'm particularly looking out for is the ability to launch android.py since that appears to be where the android logic is.

For now I can force the use of android.py by using the '-f android' list in the command line above. So I'm going to roll with that for a second and see what android.py wants from life. So I'm going to try and set up the python debugger to run the command line and then walk into the resulting code and see what the heck is going on.

One of the first things I leanred is that the python code will also look for an environmental variable 'GYP_GENERATORS'. So we could slip in Android that way.

In addition to the -D command to set variables there is also a GYP_DEFINES environmental variable looked at in line 41 of __init__.py. I'm not sure of the details of how it works but it seems potentially useful if we are going to start setting things up via environmental variables. In line 478 a similar mechanism is used for submitting GYP_GENERATOR_FLAGS. I have a feeling we'll need that at least for the ndk if not for the tool chain we will have to generate ourselves (a la how we build Node.js for Android).

#My current (incomplete, non-functional) attempt at instructions#
Setting up IntelliJ on Linux

 1. Run 'npm -g install node-gyp'
 2. Clone node-leveldown (https://github.com/rvagg/node-leveldown.git)
 3. Open IntelliJ and open a project at the root directory, node-leveldown
 4. Open any .py file and see if IntelliJ prompts you to install Python support, if so, install and reload
 5. Go to File->Project Structure and hit new and add the Python SDK as the Project SDK
 6. Go to Run->Edit Configurations->Green Plus and select Python
     1. I had to hit the "X items more" entry at the end to make Python show up
 7. For Script navigate to node-leveldown/node_modules/node-gyp/gyp/gyp_main.py and set that
 8. For Script parameters try the ones given at the end of this list.
  1. ```
binding.gyp -f android -I ./build/config.gypi -I ./node_modules/node-gyp/addon.gypi -I /home/yaron/.node-gyp/0.10.32/common.gypi -Dlibrary=shared_library -Dvisibility=default -Dnode_root_dir=/home/yaron/.node-gyp/0.10.32 -Dmodule_root_dir=. --depth=. --no-parallel --generator-output build -Goutput_dir=.
```
  1. Note that you have to replace /home/yaron with your own home path. I did try using ~ but it doesn't resolve correctly.
 9. For Python Interpreter set to 'Use specified interpreter' and choose the one set for your project
 10. For working directory set it to the full path to wherever you cloned node-leveldown



This is a test to see if redcarpet is picking things up or not
```java
int a = 1;
```

List tests:

- item 1
- item 2
 - item 1
  - item 2
   - item 3
    - item 4

* item 1
* item 2
 * item 1
 * item 2

1. item 1
2. item 2
 1. item 1
 2. item 2

1. item 1
    1. nested item 1
1. item 2
    1. nested item 2
    2. nested item 3
